
<!DOCTYPE html>
<html>
<head>
<title>Campaign Opt-In</title>
<link rel="stylesheet" href="assets/style.css">
  <!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCXrZyRjTDmwxYRNNXvbtnc0eLNdbxmPXM",
    authDomain: "emailoptin-be000.firebaseapp.com",
    databaseURL: "https://emailoptin-be000-default-rtdb.firebaseio.com",
    projectId: "emailoptin-be000",
    storageBucket: "emailoptin-be000.firebasestorage.app",
    messagingSenderId: "549214862785",
    appId: "1:549214862785:web:613c2c8435de1533b74340",
    measurementId: "G-6C92LPC8CF"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const dbRef = db.ref();
  const { get, child } = firebase.database;  

  let allClubs = [];
</script>

</head>
<body>

<h2>Campaign Opt-In</h2>
<p id="campaignName"></p>

<div id="campaignLinks"></div><br> <!-- ADD THIS -->

<input type="text" id="clubInput" placeholder="Start typing your club name..." list="clubList" />
<datalist id="clubList"></datalist>
<textarea id="notes" placeholder="Add any notes here..."></textarea>



<h3>Your Region's Status</h3>
<table border="1" id="statusTable">
<tr><th>Club</th><th>Status</th><th>Notes</th></tr>
</table>
<div id="summarySection">
  <h3>Selections Summary</h3>
  <div id="memberSummary"></div>
  <div id="prospectSummary"></div>
</div>

<script>
  // ✅ Firebase setup should already be done above
  const dbRef = firebase.database().ref();         // ✅ required
  const { get, child } = firebase.database;        // ✅ required
  let allClubs = [];                               // ✅ required

  async function populateClubList() {
    const snapshot = await get(child(dbRef, "masterClubs"));
    if (snapshot.exists()) {
      const data = snapshot.val();
      const clubList = [];
      for (const region in data) {
        data[region].forEach(club => {
          clubList.push({ name: club, region: region });
        });
      }

      allClubs = clubList.sort((a, b) => a.name.localeCompare(b.name));
      const datalist = document.getElementById("clubList");
      datalist.innerHTML = allClubs.map(club => `<option value="${club.name}">`).join("");
    }
  }

  populateClubList();
  window.choiceStore = {};
</script>
  <script>

  function submitChoice(label, choice) {
    const urlParams = new URLSearchParams(window.location.search);
    const campaign = urlParams.get('campaign');
    const clubName = document.getElementById('clubInput')?.value?.trim();

    if (!clubName) {
      alert("Please enter your club name before submitting a choice.");
      return;
    }

    // Save choice in global memory
    if (!window.choiceStore[label]) {
      window.choiceStore[label] = {};
    }
    window.choiceStore[label][clubName] = choice;

    // Save to Firebase
    const path = `responses/${campaign}/${label}/${clubName}`;
    db.ref(path).set(choice)
      .then(() => {
        console.log(`Saved ${choice} for ${clubName} under ${label}`);
      })
      .catch(error => {
        console.error("Firebase error:", error);
      });

    // Update button visual state
    updateButtonStyles(label, clubName, choice);

    // Refresh summary below
    updateSummary();
  }

  function updateButtonStyles(label, clubName, choice) {
    // Reset styles for all buttons for this label
    document.querySelectorAll(`[data-label="${label}"]`).forEach(btn => {
      btn.classList.remove('selected-opt-in', 'selected-opt-out');
    });

    // Highlight selected button
    const selectedBtn = document.querySelector(`[data-label="${label}"][data-choice="${choice}"]`);
    if (selectedBtn) {
      selectedBtn.classList.add(choice === 'Opt In' ? 'selected-opt-in' : 'selected-opt-out');
    }
  }

  function updateSummary() {
    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = '<h3>Submission Summary</h3>';

    for (const [label, clubs] of Object.entries(window.choiceStore)) {
      const section = document.createElement('div');
      section.innerHTML = `<h4>${label}</h4>`;
      const ul = document.createElement('ul');
      for (const [club, choice] of Object.entries(clubs)) {
        const li = document.createElement('li');
        li.textContent = `${club}: ${choice}`;
        ul.appendChild(li);
      }
      section.appendChild(ul);
      summaryDiv.appendChild(section);
    }
  }
</script>
<script>
// Load and display campaign email previews + buttons
async function loadCampaignPreviews() {
  const campaign = new URLSearchParams(window.location.search).get("campaign");
  document.getElementById("campaignName").innerText = `Campaign: ${campaign}`;

  const snapshot = await get(child(dbRef, `campaigns/${campaign}/links`));
  if (snapshot.exists()) {
    const links = snapshot.val();
    let html = '<div class="preview-container" style="display:flex;flex-wrap:wrap;gap:20px;">';

    links.forEach(link => {
html += `
  <div class="preview-card" style="flex:1 1 45%;border:1px solid #ccc;border-radius:8px;padding:10px;">
    <h4>${link.label}</h4>
    <iframe src="${link.url}" width="100%" height="400px" style="border:1px solid #eee;margin-bottom:10px;"></iframe>
    <button onclick="submitChoice('${link.label}', 'Opt In')" type="button" style="margin-right:10px;">Opt In</button>
    <button onclick="submitChoice('${link.label}', 'Opt Out')" type="button">Opt Out</button>
  </div>
`;    });

    html += '</div>';
    document.getElementById("campaignLinks").innerHTML = html;
  }
}

loadCampaignPreviews();

  // Expose submitChoice to global scope for button onclick
  window.submitChoice = submitChoice;

function updateSummary() {
  const memberSummary = document.getElementById('memberSummary');
  const prospectSummary = document.getElementById('prospectSummary');
  memberSummary.innerHTML = '';
  prospectSummary.innerHTML = '';

  // Member Summary
  for (const [label, data] of Object.entries(window.choiceStore.Member)) {
    const container = document.createElement('div');
    container.classList.add('summary-block');

    const title = document.createElement('h3');
    title.textContent = `Summary for ${label}`;
    container.appendChild(title);

    const list = document.createElement('ul');
    const li = document.createElement('li');
    li.textContent = `${label}: ${data.choice}`;
    list.appendChild(li);

    container.appendChild(list);
    memberSummary.appendChild(container);
  }

  // Prospect Summary
  for (const [label, data] of Object.entries(window.choiceStore.Prospect)) {
    const container = document.createElement('div');
    container.classList.add('summary-block');

    const title = document.createElement('h3');
    title.textContent = `Summary for ${label}`;
    container.appendChild(title);

    const list = document.createElement('ul');
    const li = document.createElement('li');
    li.textContent = `${label}: ${data.choice}`;
    list.appendChild(li);

    container.appendChild(list);
    prospectSummary.appendChild(container);
  }
}


</script>

</body>

</html>
