
<!DOCTYPE html>
<html>
<head>
<title>Campaign Opt-In</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>

<h2>Campaign Opt-In</h2>
<p id="campaignName"></p>

<div id="campaignLinks"></div><br> <!-- ADD THIS -->

<input type="text" id="clubInput" placeholder="Start typing your club name..." list="clubList" />
<datalist id="clubList"></datalist>
<textarea id="notes" placeholder="Add any notes here..."></textarea>



<h3>Your Region's Status</h3>
<table border="1" id="statusTable">
<tr><th>Club</th><th>Status</th><th>Notes</th></tr>
</table>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

<script>
  // Get campaign name from URL
  const params = new URLSearchParams(window.location.search);
  const campaign = params.get('campaign');
  document.getElementById('campaignName').innerText = 'Campaign: ' + campaign;

  // Load all clubs from Firebase masterClubs
  const datalist = document.getElementById('clubs');
  let clubs = [];

  db.ref('masterClubs').once('value').then(snapshot => {
    const regions = snapshot.val();

    // Flatten all region club arrays into one
    Object.values(regions).forEach(regionClubs => {
      clubs.push(...regionClubs);
    });

    // Sort alphabetically
    clubs.sort();

    // Populate datalist
    clubs.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      datalist.appendChild(option);
    });
  });

// Load Helpful Links at Page Load
db.ref('campaigns/' + campaign + '/links').once('value').then(snapshot => {
    const links = snapshot.val();
    let linkHTML = '<h3>Email Previews:</h3><div class="preview-wrapper">';

    links.forEach(link => {
        linkHTML += `
            <div class="preview-card">
                <h4>${link.label}</h4>
                <iframe src="${link.url}" width="100%" height="500px" style="border:1px solid #ccc; border-radius:8px; margin-bottom:10px;"></iframe>
                <div class="button-row">
                    <button onclick="submitChoice('${link.label}', 'Opt In')">Opt In</button>
                    <button onclick="submitChoice('${link.label}', 'Opt Out')">Opt Out</button>
                </div>
            </div>
        `;
    });

    linkHTML += '</div>';
    document.getElementById('campaignLinks').innerHTML = linkHTML;
});

        
// Submit Opt-In/Opt-Out Choice
function submitChoice(linkLabel, choice) {
    const clubName = document.getElementById('clubInput').value;
    const notes = document.getElementById('notes').value;
    const clubObj = clubs.find(c => c.name === clubName);

    if (!clubObj) {
        alert('Please select a valid club before making choices.');
        return;
    }

    const responsePath = `campaigns/${campaign}/${clubName}/responses/${linkLabel}`;
    db.ref(responsePath).set(choice);

    // Save notes and meta data too
    db.ref(`campaigns/${campaign}/${clubName}`).update({
        notes: notes,
        region: clubObj.region,
        timestamp: new Date().toISOString()
    });

    alert(`You selected "${choice}" for "${linkLabel}".`);
}


// Real-time region status
db.ref('campaigns/' + campaign).on('value', snapshot => {
    const table = document.getElementById('statusTable');
    table.innerHTML = '<tr><th>Club</th><th>Status</th><th>Notes</th></tr>';
    const data = snapshot.val();
    clubs.forEach(c => {
        if (c.region === (data && data[c.name] && data[c.name].region)) {
            const row = table.insertRow();
            row.insertCell(0).innerText = c.name;
            const status = data[c.name] ? data[c.name].status : 'No Response';
            const notes = data[c.name] ? data[c.name].notes : '';
            row.insertCell(1).innerText = status;
            row.insertCell(2).innerText = notes;
        }
    });
});
</script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, update, child, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";


  const firebaseConfig = {
  apiKey: "AIzaSyCXrZyRjTDmwxYRNNXvbtnc0eLNdbxmPXM",
  authDomain: "emailoptin-be000.firebaseapp.com",
  databaseURL: "https://emailoptin-be000-default-rtdb.firebaseio.com",
  projectId: "emailoptin-be000",
  storageBucket: "emailoptin-be000.firebasestorage.app",
  messagingSenderId: "549214862785",
  appId: "1:549214862785:web:613c2c8435de1533b74340",
  measurementId: "G-6C92LPC8CF"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db);

  let allClubs = [];


   async function populateClubList() {
    const snapshot = await get(child(dbRef, "masterClubs"));
    if (snapshot.exists()) {
      const data = snapshot.val();
      const clubList = [];
      for (const region in data) {
        data[region].forEach(club => {
          clubList.push({ name: club, region: region });
        });
      }

      allClubs = clubList.sort((a, b) => a.name.localeCompare(b.name));
      const datalist = document.getElementById("clubList");
      datalist.innerHTML = allClubs.map(club => `<option value="${club.name}">`).join("");
    }
  }

  populateClubList();

  // âœ… Save opt-in/opt-out response
  async function submitChoice(label, choice) {
    const campaign = new URLSearchParams(window.location.search).get("campaign");
    const clubName = document.getElementById("clubInput").value;
    const notes = document.getElementById("notes").value.trim();

    if (!clubName) {
      alert("Please enter your club name.");
      return;
    }

    const clubObj = allClubs.find(c => c.name === clubName);
    if (!clubObj) {
      alert("Invalid club name. Please select from the list.");
      return;
    }

    const responsePath = `campaigns/${campaign}/${clubName}/responses/${label}`;

    try {
      // Save choice (Opt In / Opt Out)
      await set(ref(db, responsePath), choice);

      // Also update metadata
      await update(ref(db, `campaigns/${campaign}/${clubName}`), {
        notes: notes,
        region: clubObj.region,
        timestamp: new Date().toISOString()
      });

      alert(`You selected "${choice}" for "${label}"`);
      document.getElementById("notes").value = "";
    } catch (error) {
      console.error("Firebase write failed:", error);
      alert("There was an error saving your response. Please try again.");
    }
  }

  // Expose submitChoice to global scope for button onclick
  window.submitChoice = submitChoice;
</script>

</body>

</html>
