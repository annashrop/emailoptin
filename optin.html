
<!DOCTYPE html>
<html>
<head>
<title>Campaign Opt-In</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>

<h2>Campaign Opt-In</h2>
<p id="campaignName"></p>

<div id="campaignLinks"></div><br> <!-- ADD THIS -->

<input type="text" id="clubInput" placeholder="Start typing your club name..." list="clubList" />
<datalist id="clubList"></datalist>
<textarea id="notes" placeholder="Add any notes here..."></textarea>



<h3>Your Region's Status</h3>
<table border="1" id="statusTable">
<tr><th>Club</th><th>Status</th><th>Notes</th></tr>
</table>
<div id="summarySection">
  <h3>Selections Summary</h3>
  <div id="Link 1"><h4>Member Campaign</h4><ul></ul></div>
  <div id="Link 2"><h4>Prospect Campaign</h4><ul></ul></div>
</div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, update, child, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";


  const firebaseConfig = {
  apiKey: "AIzaSyCXrZyRjTDmwxYRNNXvbtnc0eLNdbxmPXM",
  authDomain: "emailoptin-be000.firebaseapp.com",
  databaseURL: "https://emailoptin-be000-default-rtdb.firebaseio.com",
  projectId: "emailoptin-be000",
  storageBucket: "emailoptin-be000.firebasestorage.app",
  messagingSenderId: "549214862785",
  appId: "1:549214862785:web:613c2c8435de1533b74340",
  measurementId: "G-6C92LPC8CF"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db);

  let allClubs = [];


   async function populateClubList() {
    const snapshot = await get(child(dbRef, "masterClubs"));
    if (snapshot.exists()) {
      const data = snapshot.val();
      const clubList = [];
      for (const region in data) {
        data[region].forEach(club => {
          clubList.push({ name: club, region: region });
        });
      }

      allClubs = clubList.sort((a, b) => a.name.localeCompare(b.name));
      const datalist = document.getElementById("clubList");
      datalist.innerHTML = allClubs.map(club => `<option value="${club.name}">`).join("");
    }
  }

  populateClubList();

  // âœ… Save opt-in/opt-out response
  async function submitChoice(label, choice) {
    const campaign = new URLSearchParams(window.location.search).get("campaign");
    const clubName = document.getElementById("clubInput").value;
    const notes = document.getElementById("notes").value.trim();

    if (!clubName) {
      alert("Please enter your club name.");
      return;
    }

    const clubObj = allClubs.find(c => c.name === clubName);
    if (!clubObj) {
      alert("Invalid club name. Please select from the list.");
      return;
    }

    const responsePath = `campaigns/${campaign}/${clubName}/responses/${label}`;

    try {
      // Save choice (Opt In / Opt Out)
      await set(ref(db, responsePath), choice);

      // Also update metadata
      await update(ref(db, `campaigns/${campaign}/${clubName}`), {
        notes: notes,
        region: clubObj.region,
        timestamp: new Date().toISOString()
      });

      alert(`You selected "${choice}" for "${label}"`);
      document.getElementById("notes").value = "";
    } catch (error) {
      console.error("Firebase write failed:", error);
      alert("There was an error saving your response. Please try again.");
    }
  }
// Load and display campaign email previews + buttons
async function loadCampaignPreviews() {
  const campaign = new URLSearchParams(window.location.search).get("campaign");
  document.getElementById("campaignName").innerText = `Campaign: ${campaign}`;

  const snapshot = await get(child(dbRef, `campaigns/${campaign}/links`));
  if (snapshot.exists()) {
    const links = snapshot.val();
    let html = '<div class="preview-container" style="display:flex;flex-wrap:wrap;gap:20px;">';

    links.forEach(link => {
      html += `
        <div class="preview-card" style="flex:1 1 45%;border:1px solid #ccc;border-radius:8px;padding:10px;">
          <h4>${link.label}</h4>
          <iframe src="${link.url}" width="100%" height="400px" style="border:1px solid #eee;margin-bottom:10px;"></iframe>
          <button onclick="submitChoice('${link.label}', 'Opt In')" style="background-color:#007aff;color:white;border:none;padding:8px 12px;margin-right:8px;border-radius:4px;">Opt In</button>
          <button onclick="submitChoice('${link.label}', 'Opt Out')" style="background-color:#ccc;color:black;border:none;padding:8px 12px;border-radius:4px;">Opt Out</button>
        </div>
      `;
    });

    html += '</div>';
    document.getElementById("campaignLinks").innerHTML = html;
  }
}

loadCampaignPreviews();

  // Expose submitChoice to global scope for button onclick
  window.submitChoice = submitChoice;

function updateSummary() {
  const memberSummary = document.getElementById('memberSummary');
  const prospectSummary = document.getElementById('prospectSummary');
  memberSummary.innerHTML = '';
  prospectSummary.innerHTML = '';

  // Member Summary
  for (const [label, data] of Object.entries(window.choiceStore.Member)) {
    const container = document.createElement('div');
    container.classList.add('summary-block');

    const title = document.createElement('h3');
    title.textContent = `Summary for ${label}`;
    container.appendChild(title);

    const list = document.createElement('ul');
    const li = document.createElement('li');
    li.textContent = `${label}: ${data.choice}`;
    list.appendChild(li);

    container.appendChild(list);
    memberSummary.appendChild(container);
  }

  // Prospect Summary
  for (const [label, data] of Object.entries(window.choiceStore.Prospect)) {
    const container = document.createElement('div');
    container.classList.add('summary-block');

    const title = document.createElement('h3');
    title.textContent = `Summary for ${label}`;
    container.appendChild(title);

    const list = document.createElement('ul');
    const li = document.createElement('li');
    li.textContent = `${label}: ${data.choice}`;
    list.appendChild(li);

    container.appendChild(list);
    prospectSummary.appendChild(container);
  }
}


</script>

</body>

</html>
