
<!DOCTYPE html>
<html>
<head>
<title>Campaign Opt-In</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>

<h2>Campaign Opt-In</h2>
<p id="campaignName"></p>

<div id="campaignLinks"></div><br> <!-- ADD THIS -->

<input type="text" id="clubInput" placeholder="Start typing your club name..." list="clubs" />
<datalist id="clubs"></datalist>
<br><br>

<textarea id="notes" placeholder="Optional notes..."></textarea><br>

<button class="optin" onclick="submitChoice('Opt In')">Opt In</button>
<button class="optout" onclick="submitChoice('Opt Out')">Opt Out</button>

<h3>Your Region's Status</h3>
<table border="1" id="statusTable">
<tr><th>Club</th><th>Status</th><th>Notes</th></tr>
</table>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-init.js"></script>
<script src="assets/clubs.js"></script>

<script>
// Get campaign from URL
const params = new URLSearchParams(window.location.search);
const campaign = params.get('campaign');
document.getElementById('campaignName').innerText = 'Campaign: ' + campaign;

// Autocomplete Club Names
const datalist = document.getElementById('clubs');
clubs.forEach(c => {
    const option = document.createElement('option');
    option.value = c.name;
    datalist.appendChild(option);
});

// Load Helpful Links at Page Load
db.ref('campaigns/' + campaign + '/links').once('value').then(snapshot => {
    const links = snapshot.val();

    if (links && links.length > 0) {
        let linkHTML = '<h3>Email Previews:</h3><div class="previews-container">';
links.forEach(link => {
    linkHTML += `
        <div class="preview-card">
            <h4>${link.label}</h4>
            <iframe src="${link.url}" style="
    width: 100%; 
    height: 600px; 
    border: 1px solid #ccc; 
    border-radius: 8px; 
    margin-bottom: 10px; 
    transform: scale(1.1); 
    transform-origin: top left; 
    overflow: hidden;
"></iframe>
            <button onclick="submitChoice('${link.label}', 'Opt In')">Opt In</button>
            <button onclick="submitChoice('${link.label}', 'Opt Out')">Opt Out</button>
        </div>
    `;
});
linkHTML += '</div>'; // Close .previews-container
document.getElementById('campaignLinks').innerHTML = linkHTML;

// Submit Opt-In/Opt-Out Choice
function submitChoice(linkLabel, choice) {
    const clubName = document.getElementById('clubInput').value;
    const notes = document.getElementById('notes').value;
    const clubObj = clubs.find(c => c.name === clubName);

    if (!clubObj) {
        alert('Please select a valid club before making choices.');
        return;
    }

    const responsePath = `campaigns/${campaign}/${clubName}/responses/${linkLabel}`;
    db.ref(responsePath).set(choice);

    // Save notes and meta data too
    db.ref(`campaigns/${campaign}/${clubName}`).update({
        notes: notes,
        region: clubObj.region,
        timestamp: new Date().toISOString()
    });

    alert(`You selected "${choice}" for "${linkLabel}".`);
}


// Real-time region status
db.ref('campaigns/' + campaign).on('value', snapshot => {
    const table = document.getElementById('statusTable');
    table.innerHTML = '<tr><th>Club</th><th>Status</th><th>Notes</th></tr>';
    const data = snapshot.val();
    clubs.forEach(c => {
        if (c.region === (data && data[c.name] && data[c.name].region)) {
            const row = table.insertRow();
            row.insertCell(0).innerText = c.name;
            const status = data[c.name] ? data[c.name].status : 'No Response';
            const notes = data[c.name] ? data[c.name].notes : '';
            row.insertCell(1).innerText = status;
            row.insertCell(2).innerText = notes;
        }
    });
});
</script>

</body>

</html>
