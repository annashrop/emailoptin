
<!DOCTYPE html>
<html>
<head>
<title>Campaign Opt-In</title>
<link rel="stylesheet" href="../assets/style.css">
</head>
<body>

<h2>Campaign Opt-In</h2>
<p id="campaignName"></p>

<input type="text" id="clubInput" placeholder="Start typing your club name..." list="clubs" />
<datalist id="clubs"></datalist>
<br><br>

<textarea id="notes" placeholder="Optional notes..."></textarea><br>

<button class="optin" onclick="submitChoice('Opt In')">Opt In</button>
<button class="optout" onclick="submitChoice('Opt Out')">Opt Out</button>

<h3>Your Region's Status</h3>
<table border="1" id="statusTable">
<tr><th>Club</th><th>Status</th><th>Notes</th></tr>
</table>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="../scripts/firebase-init.js"></script>
<script src="../assets/clubs.js"></script>
<script>
const params = new URLSearchParams(window.location.search);
const campaign = params.get('campaign');
document.getElementById('campaignName').innerText = 'Campaign: ' + campaign;

const datalist = document.getElementById('clubs');
clubs.forEach(c => {
    const option = document.createElement('option');
    option.value = c.name;
    datalist.appendChild(option);
});

function submitChoice(choice) {
    const clubName = document.getElementById('clubInput').value;
    const notes = document.getElementById('notes').value;
    const clubObj = clubs.find(c => c.name === clubName);
    if (!clubObj) {
        alert('Please select a valid club.');
        return;
    }
    db.ref('campaigns/' + campaign + '/' + clubName).set({
        status: choice,
        notes: notes,
        region: clubObj.region,
        timestamp: new Date().toISOString()
    });
}

// Real-time region status
db.ref('campaigns/' + campaign).on('value', snapshot => {
    const table = document.getElementById('statusTable');
    table.innerHTML = '<tr><th>Club</th><th>Status</th><th>Notes</th></tr>';
    const data = snapshot.val();
    clubs.forEach(c => {
        if (c.region === (data && data[c.name] && data[c.name].region)) {
            const row = table.insertRow();
            row.insertCell(0).innerText = c.name;
            const status = data[c.name] ? data[c.name].status : 'No Response';
            const notes = data[c.name] ? data[c.name].notes : '';
            row.insertCell(1).innerText = status;
            row.insertCell(2).innerText = notes;
        }
    });
});
</script>
</body>
</html>
